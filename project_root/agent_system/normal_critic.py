from langchain_gigachat.chat_models import GigaChat
from langchain_core.messages import SystemMessage, HumanMessage


class CriticNormalAgent:
    """Агент-критик для проверки качества рубрикации."""

    def __init__(self, auth_key: str):
        self.auth_key = auth_key
        self.model = GigaChat(credentials=auth_key, verify_ssl_certs=False)

    def run(self, state: dict) -> dict:
        article_text = state.get("article_text", "")[:5000]  # Ограничиваем длину
        rubric_result = state.get("rubric_result_keyword", "")

        # Промпт критика
        critique_prompt = """Ты — научный редактор-корректор с экспертизой в области библиографического оформления (ГОСТ Р 7.0.5-2008, ГОСТ 7.1-2003).
Твоя задача — проверять, правильно ли агент-нормализатор привел текст статьи к единому стандарту оформления.

ВНИМАТЕЛЬНО ПРОВЕРЬ НОРМАЛИЗОВАННЫЙ ТЕКСТ НА СООТВЕТСТВИЕ КРИТЕРИЯМ:

### КРИТЕРИИ КАЧЕСТВА:

1. **Оформление заголовков**
   - Название статьи: прописными буквами, без точки в конце.
   - Подзаголовки разделов (Введение, Методы, Результаты): единообразное форматирование.
   - Нумерация разделов должна быть последовательной (1, 2, 3... или I, II, III...).

2. **Форматирование списка литературы**
   - Все источники пронумерованы последовательно.
   - Единообразие стиля цитирования (или ГОСТ, или APA, или IEEE — но не вперемешку).
   - Обязательные элементы: автор(ы), название, издание/журнал, год, страницы.
   - Отсутствие ссылок вида "Источник 1" без расшифровки.

3. **Оформление формул и таблиц**
   - Формулы должны быть пронумерованы справа (если их больше 3).
   - Таблицы должны иметь заголовок (Таблица 1. Название).
   - Единицы измерения в таблицах должны быть явно указаны.

4. **Язык и орфография**
   - Отсутствие орфографических и пунктуационных ошибок.
   - Единообразие терминов (например, если используется "нейросеть", не должно быть "нейронная сеть" и "искусственная нейронная сеть" одновременно).
   - Соответствие нормам русского языка (или английского, если статья на английском).

5. **Удаление лишних элементов**
   - Отсутствие дублирующихся разделов.
   - Удалены артефакты распознавания (например, "стр. 1 из 15" посреди текста).
   - Нет битых ссылок ("см. рис. [ОШИБКА]").

### ИНСТРУКЦИЯ ПО ВЕРДИКТУ:

Если текст **КОРРЕКТНО НОРМАЛИЗОВАН**:
Верни ТОЛЬКО: APPROVED

Если текст **НЕКОРРЕКТНО НОРМАЛИЗОВАН**:
Верни вердикт строго в формате:
REJECT: <Список конкретных ошибок с указанием строки/раздела, где они обнаружены>

### ПРИМЕРЫ ОШИБОК (ДЛЯ ПОНИМАНИЯ):
❌ Список литературы: "1. Иванов И.И. Статья. 2. [ПРОПУЩЕНО]. 3. Петров П.П..." (Пропущенный элемент №2)
❌ Заголовок: "ВВЕДЕНИЕ." (Точка в заголовке — ошибка по ГОСТ)
❌ Формула в середине предложения без нумерации, хотя далее есть ссылка на неё ("как показано в (1)...")
❌ Разнобой в терминах: "machine learning" и "машинное обучение" используются как синонимы без пояснений

### ВХОДНЫЕ ДАННЫЕ:
Исходный текст (до нормализации): {article}
Нормализованный текст: {rubric}

Твой вердикт:

"""

        messages = [
            SystemMessage(content=critique_prompt.format(
                article=article_text,
                rubric=rubric_result
            ))
        ]

        response = self.model.invoke(messages).content.strip()

        # Определяем, одобрено или отклонено
        if response.startswith("APPROVED"):
            return {
                "critique_nor": "",
                "status": ["critic_approved"]
            }

        return {
            "critique_nor": response,
            "status": ["critic_rejected"]
        }
