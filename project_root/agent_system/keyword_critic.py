from langchain_gigachat.chat_models import GigaChat
from langchain_core.messages import SystemMessage, HumanMessage


class CriticKeywordAgent:
    """Агент-критик для проверки качества рубрикации."""

    def __init__(self, auth_key: str):
        self.auth_key = auth_key
        self.model = GigaChat(credentials=auth_key, verify_ssl_certs=False)

    def run(self, state: dict) -> dict:
        article_text = state.get("article_text", "")[:5000]  # Ограничиваем длину
        rubric_result = state.get("rubric_result_keyword", "")

        # Промпт критика
        critique_prompt = """Ты — строгий научный библиограф и эксперт по индексированию научных баз данных (Scopus, Web of Science, РИНЦ).
Твоя единственная задача — проверять качество списка ключевых слов, выделенных другим агентом.

ВНИМАТЕЛЬНО ПРОВЕРЬ ПРЕДОСТАВЛЕННЫЕ КЛЮЧЕВЫЕ СЛОВА НА СООТВЕТСТВИЕ КРИТЕРИЯМ:

1. **Специфичность**: Слова не должны быть слишком общими (например, "анализ", "система", "метод", "вопрос"). Хорошее ключевое слово уточняет область (например, "спектральный анализ", "мультиагентная система").
2. **Соответствие тексту**: Слова должны реально отражать суть предоставленного текста статьи, а не быть галлюцинацией.
3. **Количество**: Список должен содержать от 5 до 15 ключевых фраз.
4. **Формат**: 
   - Все слова должны быть в именительном падеже.
   - Ключевые слова не должны быть целыми предложениями.
   - Отсутствие дубликатов (синонимов, стоящих рядом).

### ИНСТРУКЦИЯ ПО ВЕРДИКТУ:

Если список ключевых слов **КАЧЕСТВЕННЫЙ**:
Верни ТОЛЬКО одно слово: APPROVED

Если список ключевых слов **НЕКАЧЕСТВЕННЫЙ**:
Верни вердикт в формате:
REJECT: <Краткий список конкретных ошибок>

Примеры плохих ответов (для понимания, что отклонять):
- "анализ, проблема, решение, статья, вывод" (Слишком общие слова)
- "разработка алгоритма для решения задачи коммивояжера методом ветвей и границ" (Слишком длинная фраза, нужно разбить)
- "котики, собачки" (Если статья про ядерную физику — это галлюцинация)

### ВХОДНЫЕ ДАННЫЕ:
Текст статьи (фрагмент): {article}
Предложенные ключевые слова: {rubric}
"""

        messages = [
            SystemMessage(content=critique_prompt.format(
                article=article_text,
                rubric=rubric_result
            ))
        ]

        response = self.model.invoke(messages).content.strip()

        # Определяем, одобрено или отклонено
        if response.startswith("APPROVED"):
            return {
                "critique_key": "",
                "status": ["critic_approved"]
            }

        return {
            "critique_key": response,
            "status": ["critic_rejected"]
        }
