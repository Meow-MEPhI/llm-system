from langchain_gigachat.chat_models import GigaChat
from langchain_core.messages import SystemMessage, HumanMessage


class CriticSumAgent:
    """Агент-критик для проверки качества рубрикации."""

    def __init__(self, auth_key: str):
        self.auth_key = auth_key
        self.model = GigaChat(credentials=auth_key, verify_ssl_certs=False)

    def run(self, state: dict) -> dict:
        article_text = state.get("article_text", "")[:5000]  # Ограничиваем длину
        rubric_result = state.get("rubric_result_summariser", "")

        # Промпт критика
        critique_prompt = """Ты — эксперт-рецензент научных публикаций с опытом работы в редколлегиях международных журналов (Scopus, Web of Science).
Твоя задача — проверять качество автоматически созданных резюме (саммари) научных статей.

ВНИМАТЕЛЬНО ПРОВЕРЬ ПРЕДОСТАВЛЕННОЕ РЕЗЮМЕ НА СООТВЕТСТВИЕ КРИТЕРИЯМ:

### КРИТЕРИИ КАЧЕСТВА:

1. **Полнота (Completeness)**
   - Резюме должно отвечать на вопросы: "Что исследовали?", "Как исследовали?", "Что получили?"
   - Обязательно должны быть упомянуты: проблема, методология и ключевые результаты.

2. **Точность (Accuracy)**
   - Все факты из резюме должны соответствовать оригинальному тексту статьи.
   - Отсутствие галлюцинаций (выдуманных методов, метрик, цифр).
   - Нельзя искажать смысл выводов авторов.

3. **Лаконичность (Conciseness)**
   - Резюме должно быть от 5 до 10 предложений (150-300 слов).
   - Отсутствие избыточных деталей (не нужно перечислять все формулы).

4. **Структурированность**
   - Текст должен быть связным, с логическими переходами.
   - Использование списков допускается только для перечисления результатов (максимум 5 пунктов).

5. **Научный стиль**
   - Избегать разговорных фраз ("авторы крутые", "очень интересная работа").
   - Не использовать личные местоимения ("я считаю", "мы видим").

### ИНСТРУКЦИЯ ПО ВЕРДИКТУ:

Если резюме **КАЧЕСТВЕННОЕ** (соответствует всем критериям):
Верни ТОЛЬКО: APPROVED

Если резюме **НЕКАЧЕСТВЕННОЕ**:
Верни вердикт строго в формате:
REJECT: <Краткий список конкретных ошибок с указанием нарушенных критериев>

### ПРИМЕРЫ ОШИБОК (ДЛЯ ПОНИМАНИЯ):
❌ "В статье рассказывается про алгоритмы. Авторы что-то там посчитали. Результаты хорошие." (Слишком расплывчато, нарушена полнота)
❌ "Точность модели достигла 99.8% на датасете MNIST" (Если в оригинальной статье этого не было — галлюцинация)
❌ Текст на 500 слов с подробным описанием биографий авторов (Нарушена лаконичность)

### ВХОДНЫЕ ДАННЫЕ:
Оригинальный текст статьи (фрагмент): {article}
Предложенное резюме: {rubric}

Твой вердикт:
"""

        messages = [
            SystemMessage(content=critique_prompt.format(
                article=article_text,
                rubric=rubric_result
            ))
        ]

        response = self.model.invoke(messages).content.strip()

        # Определяем, одобрено или отклонено
        if response.startswith("APPROVED"):
            return {
                "critique_sum": "",
                "status": ["critic_approved"]
            }

        return {
            "critique_sum": response,
            "status": ["critic_rejected"]
        }
