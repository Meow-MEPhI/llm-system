Тестирование Python-приложений: pytest, fixtures и coverage

Автоматизированное тестирование — фундамент надёжного ПО. Pytest — наиболее популярный фреймворк для Python, сочетающий простоту использования с мощными возможностями. В отличие от unittest, pytest требует минимум boilerplate, использует обычные assert вместо специальных методов.

Простейший тест — функция с префиксом test_: def test_addition(): assert add(2, 3) == 5. Pytest автоматически обнаруживает тестовые файлы (test_*.py, *_test.py) и функции. Запуск pytest в терминале выполняет все тесты, показывая зелёные точки для успешных, F для падений.

Fixtures предоставляют тестовым функциям переиспользуемые ресурсы. @pytest.fixture декоратор превращает функцию в фикстуру: @pytest.fixture def db(): database = setup_database(); yield database; database.close(). Тест принимает фикстуру как аргумент: def test_query(db): assert db.query("SELECT 1") == 1.

Область видимости (scope) контролирует частоту создания фикстур. Scope="function" (по умолчанию) создаёт новую фикстуру для каждого теста, обеспечивая изоляцию. Scope="module" или "session" создают единожды для модуля/сессии, экономя время на дорогих операциях вроде подключения к БД.

Parametrize запускает тест с множеством входных данных. @pytest.mark.parametrize("input,expected", [(2,4), (3,9), (4,16)]) def test_square(input, expected): assert square(input) == expected. Один тест генерирует три отдельных выполнения. Это компактнее дублирования кода и улучшает диагностику при падениях.

Coverage измеряет процент кода, покрытого тестами. Pytest-cov плагин интегрирует coverage.py: pytest --cov=myapp --cov-report=html. HTML-отчёт визуализирует покрытые и непокрытые строки. 80%+ coverage — хороший показатель, но 100% не гарантирует отсутствие багов.

Mocking изолирует тестируемый код от внешних зависимостей. unittest.mock.patch подменяет функции/объекты: with patch('requests.get') as mock_get: mock_get.return_value.json.return_value = {"data": "test"}. Тесты API-клиентов не делают реальных HTTP-запросов, ускоряясь и избегая флапов.
